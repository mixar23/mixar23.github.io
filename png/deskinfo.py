#1st variant ~700 lines of code